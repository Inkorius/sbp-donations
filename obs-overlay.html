<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Overlay - SBP Donations</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: transparent !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–Ω–∞—Ç–æ–≤ */
        #donations-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* –°—Ç–∏–ª—å –æ–¥–Ω–æ–≥–æ –¥–æ–Ω–∞—Ç–∞ */
        .donation-item {
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.95) 0%, rgba(101, 31, 255, 0.95) 100%);
            color: white;
            margin: 10px;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #ff4081;
            max-width: 400px;
            opacity: 0;
            position: relative;
            overflow: hidden;
            pointer-events: auto;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateX(100%);
            }
            10% {
                opacity: 1;
                transform: translateX(0);
            }
            90% {
                opacity: 1;
                transform: translateX(0);
            }
            100% {
                opacity: 0;
                transform: translateX(-100%);
            }
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º */
        @keyframes bigAmount {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã –¥–æ–Ω–∞—Ç–∞ */
        .donation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .donor-name {
            font-weight: 700;
            font-size: 1.3rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .donation-amount {
            font-weight: 800;
            font-size: 1.5rem;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .donation-message {
            font-size: 1rem;
            line-height: 1.4;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ */
        .new-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4081;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) */
        .controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .controls.active {
            display: block;
        }

        /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å—ã */
        .position-top-left { top: 20px; left: 20px; }
        .position-top-right { top: 20px; right: 20px; }
        .position-bottom-left { bottom: 20px; left: 20px; }
        .position-bottom-right { bottom: 20px; right: 20px; }
        .position-center { top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 999;
        }

        /* –¢–µ–º–∞ "–ú–∏–Ω–∏–º–∞–ª–∏–∑–º" */
        .theme-minimal .donation-item {
            background: rgba(0, 0, 0, 0.8);
            border-left: 3px solid #7c4dff;
            box-shadow: none;
        }

        .theme-minimal .donation-amount {
            color: #7c4dff;
        }

        /* –¢–µ–º–∞ "–Ø—Ä–∫–∞—è" */
        .theme-bright .donation-item {
            background: linear-gradient(135deg, #ff4081 0%, #7c4dff 100%);
            border-left: 5px solid #ffeb3b;
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ–Ω–∞—Ç–æ–≤ -->
    <div id="donations-container"></div>

    <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
    <div class="connection-status" id="connection-status">
        <span id="status-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
    </div>

    <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (Ctrl+D —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å) -->
    <div class="controls" id="debug-controls">
        <div>–î–æ–Ω–∞—Ç–æ–≤: <span id="counter">0</span></div>
        <div>–†–µ–∂–∏–º: <span id="mode">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</span></div>
        <div>–°—Ç–∞—Ç—É—Å: <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span></div>
        <div>–°—Ç—Ä–∏–º–µ—Ä ID: <span id="streamer-id">-</span></div>
        <div>
            <button onclick="testDonation()">–¢–µ—Å—Ç –¥–æ–Ω–∞—Ç</button>
            <button onclick="clearDonations()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button onclick="toggleTheme()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="js/supabase-cdn.js"></script>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const urlParams = new URLSearchParams(window.location.search);
        const config = {
            username: urlParams.get('user') || 'parfjek',
            duration: parseInt(urlParams.get('duration')) || 10000,
            position: urlParams.get('position') || 'top-right',
            maxDonations: parseInt(urlParams.get('max')) || 5,
            animation: urlParams.get('animation') || 'slideIn',
            sound: urlParams.has('sound'),
            theme: urlParams.get('theme') || 'default',
            debug: urlParams.has('debug'),
            useRealtime: !urlParams.has('no-realtime') // –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ ?no-realtime=true
        };

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentProfileId = null;
        let donationsCount = 0;
        const donationsQueue = [];
        let currentTheme = config.theme;
        let connectionMode = 'initializing'; // 'realtime', 'polling', 'offline'
        let lastCheckTime = new Date().toISOString();
        let pollingInterval = null;

        // ========== –û–°–ù–û–í–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('supabase-loaded', initializeOverlay);

        async function initializeOverlay() {
            console.log('üé¨ OBS Overlay: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            updateStatus('üîç –ü–æ–∏—Å–∫ —Å—Ç—Ä–∏–º–µ—Ä–∞...');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            console.log('‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', config);
            if (config.debug) {
                document.getElementById('debug-controls').classList.add('active');
            }

            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç—Ä–∏–º–µ—Ä–∞
                const { data: profile, error } = await window.supabase
                    .from('profiles')
                    .select('id, username, display_name')
                    .eq('username', config.username)
                    .single();

                if (error || !profile) {
                    updateStatus(`‚ùå –°—Ç—Ä–∏–º–µ—Ä "${config.username}" –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                    showErrorMessage(`–°—Ç—Ä–∏–º–µ—Ä "${config.username}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    return;
                }

                currentProfileId = profile.id;
                document.getElementById('streamer-id').textContent = profile.id.substring(0, 8) + '...';
                updateStatus(`‚úÖ –°—Ç—Ä–∏–º–µ—Ä: ${profile.display_name || profile.username}`);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
                document.body.classList.add(`theme-${currentTheme}`);

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–Ω–∞—Ç—ã
                await loadRecentDonations(profile.id);

                // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Realtime
                if (config.useRealtime) {
                    await setupRealtime(profile.id);
                    
                    // –ï—Å–ª–∏ Realtime –Ω–µ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ polling
                    setTimeout(() => {
                        if (connectionMode !== 'realtime') {
                            console.log('‚è∞ Realtime timeout, switching to polling...');
                            setupPolling(profile.id);
                        }
                    }, 10000);
                } else {
                    // –ï—Å–ª–∏ Realtime –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                    setupPolling(profile.id);
                }

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                showErrorMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }

        // ========== REALTIME –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï ==========
        async function setupRealtime(profileId) {
            console.log('üîå –ü—Ä–æ–±—É—é –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Realtime...');
            updateStatus('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Realtime...');
            
            try {
                const channel = window.supabase.channel(`donations-${profileId}`, {
                    config: {
                        broadcast: { ack: false },
                        presence: { key: profileId }
                    }
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö –¥–æ–Ω–∞—Ç–æ–≤
                channel.on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'donations',
                        filter: `profile_id=eq.${profileId}`
                    },
                    (payload) => {
                        console.log('üéØ –ù–æ–≤—ã–π –¥–æ–Ω–∞—Ç —á–µ—Ä–µ–∑ Realtime:', payload.new);
                        addDonation(payload.new);
                    }
                ).subscribe((status) => {
                    console.log('üì° Realtime —Å—Ç–∞—Ç—É—Å:', status);
                    
                    if (status === 'SUBSCRIBED') {
                        connectionMode = 'realtime';
                        document.getElementById('mode').textContent = 'Realtime';
                        updateStatus('‚úÖ Realtime –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                        console.log('‚úÖ Realtime —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                    } else if (status === 'TIMED_OUT' || status === 'CHANNEL_ERROR') {
                        updateStatus('‚ö†Ô∏è Realtime –æ—à–∏–±–∫–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ polling...', 'warning');
                        setupPolling(profileId);
                    }
                });

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Realtime:', error);
                setupPolling(profileId);
            }
        }

        // ========== POLLING (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥) ==========
        function setupPolling(profileId) {
            if (connectionMode === 'polling') return;
            
            console.log('üîÑ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é polling (–æ–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)...');
            connectionMode = 'polling';
            document.getElementById('mode').textContent = 'Polling';
            updateStatus('üîÑ –ò—Å–ø–æ–ª—å–∑—É—é polling...', 'warning');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –¥–æ–Ω–∞—Ç–æ–≤
            async function checkNewDonations() {
                try {
                    const { data: newDonations, error } = await window.supabase
                        .from('donations')
                        .select('*')
                        .eq('profile_id', profileId)
                        .gt('created_at', lastCheckTime)
                        .order('created_at', { ascending: true });
                    
                    if (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ polling:', error);
                        return;
                    }
                    
                    if (newDonations && newDonations.length > 0) {
                        console.log(`üì• –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö –¥–æ–Ω–∞—Ç–æ–≤: ${newDonations.length}`);
                        newDonations.forEach(donation => {
                            addDonation(donation);
                        });
                        lastCheckTime = new Date().toISOString();
                        updateStatus(`üì• –ü–æ–ª—É—á–µ–Ω–æ: ${newDonations.length} –¥–æ–Ω–∞—Ç(–æ–≤)`, 'success');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ polling:', error);
                }
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            pollingInterval = setInterval(checkNewDonations, 3000);
            
            // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
            checkNewDonations();
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –ü–û–°–õ–ï–î–ù–ò–• –î–û–ù–ê–¢–û–í ==========
        async function loadRecentDonations(profileId) {
            try {
                const { data: recentDonations } = await window.supabase
                    .from('donations')
                    .select('*')
                    .eq('profile_id', profileId)
                    .order('created_at', { descending: true })
                    .limit(config.maxDonations);
                
                if (recentDonations && recentDonations.length > 0) {
                    console.log(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–æ–Ω–∞—Ç–æ–≤: ${recentDonations.length}`);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (—Å—Ç–∞—Ä—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    recentDonations.reverse().forEach(donation => {
                        addDonation(donation, true); // true = –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
                    });
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
            }
        }

        // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –î–û–ù–ê–¢–ê –ù–ê –≠–ö–†–ê–ù ==========
        function addDonation(donation, skipAnimation = false) {
            donationsCount++;
            document.getElementById('counter').textContent = donationsCount;

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–æ–Ω–∞—Ç–∞
            const donationEl = document.createElement('div');
            donationEl.className = `donation-item position-${config.position}`;
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å—É–º–º
            if (donation.amount >= 1000) {
                donationEl.style.borderLeftColor = '#ffeb3b';
                donationEl.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.95) 0%, rgba(255, 152, 0, 0.95) 100%)';
                donationEl.classList.add('big-donation');
            } else if (donation.amount >= 500) {
                donationEl.style.borderLeftColor = '#4caf50';
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            donationEl.innerHTML = `
                <div class="new-indicator">NEW</div>
                <div class="donation-header">
                    <div class="donor-name">${escapeHtml(donation.donor_name)}</div>
                    <div class="donation-amount">${formatAmount(donation.amount)} ‚ÇΩ</div>
                </div>
                ${donation.message ? `<div class="donation-message">${escapeHtml(donation.message)}</div>` : ''}
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            const container = document.getElementById('donations-container');
            container.appendChild(donationEl);

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            donationsQueue.push(donationEl);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–æ–Ω–∞—Ç–æ–≤
            if (donationsQueue.length > config.maxDonations) {
                const oldDonation = donationsQueue.shift();
                if (oldDonation.parentNode) {
                    oldDonation.style.animation = 'none';
                    oldDonation.style.opacity = '0';
                    setTimeout(() => {
                        if (oldDonation.parentNode) {
                            oldDonation.parentNode.removeChild(oldDonation);
                        }
                    }, 300);
                }
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é (–µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–ø—É—â–µ–Ω–∞)
            if (!skipAnimation) {
                donationEl.style.animation = `${config.animation} ${config.duration}ms forwards`;
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
                if (config.sound) {
                    playNotificationSound(donation.amount);
                }
            } else {
                donationEl.style.opacity = '1';
                donationEl.style.transform = 'translateX(0)';
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞
            setTimeout(() => {
                const index = donationsQueue.indexOf(donationEl);
                if (index > -1) {
                    donationsQueue.splice(index, 1);
                }
                if (donationEl.parentNode) {
                    donationEl.style.opacity = '0';
                    donationEl.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (donationEl.parentNode) {
                            donationEl.parentNode.removeChild(donationEl);
                        }
                    }, 500);
                }
            }, skipAnimation ? config.duration : config.duration);
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatAmount(amount) {
            return parseFloat(amount).toFixed(0);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            const statusTextEl = document.getElementById('status-text');
            
            if (statusEl) statusEl.textContent = message;
            if (statusTextEl) statusTextEl.textContent = message;
            
            // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                connectionStatus.style.background = 
                    type === 'error' ? 'rgba(244, 67, 54, 0.8)' :
                    type === 'success' ? 'rgba(76, 175, 80, 0.8)' :
                    type === 'warning' ? 'rgba(255, 152, 0, 0.8)' :
                    'rgba(0, 0, 0, 0.7)';
            }
            
            console.log(`üì¢ ${message}`);
        }

        function showErrorMessage(message) {
            const errorEl = document.createElement('div');
            errorEl.className = `donation-item position-center`;
            errorEl.innerHTML = `
                <div style="color: #ff4081; text-align: center;">
                    <strong>‚ö†Ô∏è –û—à–∏–±–∫–∞</strong><br>
                    ${message}
                </div>
            `;
            errorEl.style.background = 'rgba(0, 0, 0, 0.9)';
            errorEl.style.opacity = '1';
            errorEl.style.animation = 'none';
            document.getElementById('donations-container').appendChild(errorEl);
        }

        function playNotificationSound(amount) {
            try {
                const soundUrl = amount >= 1000 ? 
                    'https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3' :
                    'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3';
                
                const audio = new Audio(soundUrl);
                audio.volume = 0.2;
                audio.play().catch(e => console.log('üîá –ó–≤—É–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º'));
            } catch (e) {
                console.log('üîá –ó–≤—É–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }

        // ========== –§–£–ù–ö–¶–ò–ò –û–¢–õ–ê–î–ö–ò ==========
        function testDonation() {
            const testNames = ['–ò–≤–∞–Ω', '–ú–∞—Ä–∏—è', '–ê–ª–µ–∫—Å–µ–π', '–î–º–∏—Ç—Ä–∏–π', '–ê–Ω–Ω–∞'];
            const testMessages = [
                '–°–ø–∞—Å–∏–±–æ –∑–∞ —Å—Ç—Ä–∏–º!',
                '–û—Ç–ª–∏—á–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç!',
                '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!',
                '–õ—É—á—à–∏–π —Å—Ç—Ä–∏–º–µ—Ä!',
                '–ó–∞–±–∏—Ä–∞–π—Ç–µ –Ω–∞ –∫–æ—Ñ–µ :)'
            ];
            
            const testDonation = {
                donor_name: testNames[Math.floor(Math.random() * testNames.length)],
                amount: Math.floor(Math.random() * 2000) + 10,
                message: testMessages[Math.floor(Math.random() * testMessages.length)]
            };
            
            console.log('üß™ –¢–µ—Å—Ç–æ–≤—ã–π –¥–æ–Ω–∞—Ç:', testDonation);
            addDonation(testDonation);
        }

        function clearDonations() {
            const container = document.getElementById('donations-container');
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            donationsQueue.length = 0;
            donationsCount = 0;
            document.getElementById('counter').textContent = '0';
            console.log('üßπ –í—Å–µ –¥–æ–Ω–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
        }

        function toggleTheme() {
            const themes = ['default', 'minimal', 'bright'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextTheme = themes[(currentIndex + 1) % themes.length];
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ç–µ–º—É
            document.body.classList.remove(`theme-${currentTheme}`);
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
            document.body.classList.add(`theme-${nextTheme}`);
            
            currentTheme = nextTheme;
            updateStatus(`üé® –¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: ${nextTheme}`);
        }

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–û–ë–´–¢–ò–Ø ==========
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã –ø–æ Ctrl+D
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                document.getElementById('debug-controls').classList.toggle('active');
                console.log('üîß –û—Ç–ª–∞–¥–∫–∞ ' + (document.getElementById('debug-controls').classList.contains('active') ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–æ—Ç–∫–ª—é—á–µ–Ω–∞'));
            }
        });

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('üöÄ OBS Overlay –∑–∞–ø—É—â–µ–Ω —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π:', config);
        console.log('üí° –ù–∞–∂–º–∏—Ç–µ Ctrl+D –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ –æ—Ç–ª–∞–¥–∫–∏');
        console.log('üåê URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:');
        console.log('  ?user=username       - –∏–º—è —Å—Ç—Ä–∏–º–µ—Ä–∞');
        console.log('  ?duration=10000      - –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –≤ ms');
        console.log('  ?position=top-right  - –ø–æ–∑–∏—Ü–∏—è (top-left, top-right, etc)');
        console.log('  ?max=5               - –º–∞–∫—Å–∏–º—É–º –¥–æ–Ω–∞—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ');
        console.log('  ?animation=slideIn   - –∞–Ω–∏–º–∞—Ü–∏—è (slideIn, fadeIn)');
        console.log('  ?sound=true          - –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫');
        console.log('  ?theme=default       - —Ç–µ–º–∞ (default, minimal, bright)');
        console.log('  ?debug=true          - –ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –æ—Ç–ª–∞–¥–∫–∏');
        console.log('  ?no-realtime=true    - –æ—Ç–∫–ª—é—á–∏—Ç—å Realtime (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ polling)');
    </script>
</body>
</html>